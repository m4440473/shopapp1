generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id               String   @id @default(cuid())
  email            String   @unique
  name             String?
  role             String   @default("MACHINIST")
  active           Boolean  @default(true)
  // Credentials provider (nullable)
  passwordHash     String?

  orders           Order[]  @relation("AssignedOrders")
  quotes           Quote[]
  notes            Note[]
  timeLogs         TimeLog[]
  timeEntries      TimeEntry[]
  checklistToggles OrderChecklist[] @relation("ChecklistToggledBy")
  uploadedAttachments Attachment[] @relation("UserAttachments")
  statusHistories StatusHistory[] @relation("UserStatusHistory")

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Customer {
  id      String  @id @default(cuid())
  name    String
  contact String?
  phone   String?
  email   String?
  address String?

  orders  Order[]
  quotes  Quote[]

  @@index([name])
  @@unique([name])
}

model Material {
  id    String  @id @default(cuid())
  name  String  @unique
  spec  String?
  notes String?

  parts OrderPart[]
  quoteParts QuotePart[] @relation("QuotePartMaterial")
}

model Vendor {
  id     String  @id @default(cuid())
  name   String  @unique
  url    String?
  phone  String?
  notes  String?

  orders Order[]
  quoteVendorItems QuoteVendorItem[]
}

model Order {
  id               String   @id @default(cuid())
  orderNumber      String
  business         String   @default("STD")
  customerId       String
  customer         Customer @relation(fields: [customerId], references: [id])
  status           String
  priority         String
  dueDate          DateTime
  receivedDate     DateTime
  modelIncluded    Boolean @default(false)
  materialNeeded   Boolean @default(false)
  materialOrdered  Boolean @default(false)
  vendorId         String?
  vendor           Vendor? @relation(fields: [vendorId], references: [id])
  poNumber         String?
  assignedMachinistId String?
  assignedMachinist   User? @relation("AssignedOrders", fields: [assignedMachinistId], references: [id])
  parts            OrderPart[]
  checklist        OrderChecklist[]
  charges          OrderCharge[]
  attachments      Attachment[]
  partAttachments  PartAttachment[]
  notes            Note[]
  timeLogs         TimeLog[]
  timeEntries      TimeEntry[]
  statusHistory    StatusHistory[]
}

model OrderPart {
  id         String   @id @default(cuid())
  orderId    String
  order      Order    @relation(fields: [orderId], references: [id])
  partNumber String
  quantity   Int
  materialId String?
  material   Material? @relation(fields: [materialId], references: [id])
  notes      String?
  stockSize  String?
  cutLength  String?
  charges    OrderCharge[]
  attachments PartAttachment[]
  checklistItems OrderChecklist[]
}

model OrderChecklist {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  partId      String?
  part        OrderPart? @relation(fields: [partId], references: [id], onDelete: SetNull)
  chargeId    String?
  charge      OrderCharge? @relation(fields: [chargeId], references: [id], onDelete: SetNull)
  departmentId String?
  department  Department? @relation(fields: [departmentId], references: [id])
  addonId     String?
  addon       Addon?    @relation(fields: [addonId], references: [id])
  completed   Boolean  @default(false)
  isActive    Boolean  @default(true)
  toggledById String?
  toggledBy   User?    @relation("ChecklistToggledBy", fields: [toggledById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([orderId, addonId, partId])
  @@unique([orderId, chargeId])
}

model Note {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  content   String
  createdAt DateTime @default(now())
}

model TimeLog {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  phase     String
  minutes   Int
  createdAt DateTime @default(now())
}

model TimeEntry {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id])
  partId    String?
  part      OrderPart? @relation(fields: [partId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  operation String
  startedAt DateTime @default(now())
  endedAt   DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, endedAt])
  @@index([orderId])
  @@index([partId])
}

model Attachment {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id])
  url       String?
  storagePath String?
  label     String?
  mimeType  String?
  uploadedById String?
  uploadedBy   User? @relation("UserAttachments", fields: [uploadedById], references: [id])
  createdAt DateTime @default(now())

  @@index([storagePath])
}

model StatusHistory {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id])
  from      String
  to        String
  userId    String?
  user      User?    @relation("UserStatusHistory", fields: [userId], references: [id])
  reason    String?
  createdAt DateTime @default(now())
}

model Addon {
  id          String   @id @default(cuid())
  name        String
  description String?
  rateType    String
  rateCents   Int
  active      Boolean  @default(true)
  departmentId String
  department  Department @relation(fields: [departmentId], references: [id])

  quoteSelections QuoteAddonSelection[]
  orderChecklist  OrderChecklist[]
  orderCharges    OrderCharge[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([active])
  @@unique([name])
}

model Department {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  addons    Addon[]
  charges   OrderCharge[]
  checklistItems OrderChecklist[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrderCharge {
  id           String   @id @default(cuid())
  orderId      String
  order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  partId       String?
  part         OrderPart? @relation(fields: [partId], references: [id], onDelete: Cascade)
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])
  addonId      String?
  addon        Addon?   @relation(fields: [addonId], references: [id])
  checklistItems OrderChecklist[]
  kind         String
  name         String
  description  String?
  quantity     Decimal  @default(1)
  unitPrice    Decimal  @default(0)
  sortOrder    Int      @default(0)
  completedAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([orderId])
  @@index([partId])
  @@index([departmentId])
}

model PartAttachment {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  partId      String
  part        OrderPart @relation(fields: [partId], references: [id], onDelete: Cascade)
  kind        String
  url         String?
  storagePath String?
  label       String?
  mimeType    String?
  createdAt   DateTime @default(now())

  @@index([orderId])
  @@index([partId])
  @@index([storagePath])
}

model Quote {
  id               String   @id @default(cuid())
  quoteNumber      String
  business         String   @default("STD")
  companyName      String
  contactName      String?
  contactEmail     String?
  contactPhone     String?
  customerId       String?
  customer         Customer? @relation(fields: [customerId], references: [id])
  status           String    @default("DRAFT")
  materialSummary  String?
  purchaseItems    String?
  requirements     String?
  notes            String?
  multiPiece       Boolean   @default(false)
  basePriceCents   Int       @default(0)
  addonsTotalCents Int       @default(0)
  vendorTotalCents Int       @default(0)
  totalCents       Int       @default(0)
  metadata         String?

  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])

  parts           QuotePart[]
  vendorItems     QuoteVendorItem[]
  addonSelections QuoteAddonSelection[]
  attachments     QuoteAttachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([companyName])
  @@unique([quoteNumber])
}

model QuotePart {
  id         String @id @default(cuid())
  quoteId    String
  quote      Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  name       String
  description String?
  quantity   Int    @default(1)
  pieceCount Int    @default(1)
  notes      String?
  partNumber String?
  materialId String?
  material   Material? @relation("QuotePartMaterial", fields: [materialId], references: [id])
  stockSize  String?
  cutLength  String?
  addonSelections QuoteAddonSelection[]
}

model QuoteVendorItem {
  id              String  @id @default(cuid())
  quoteId         String
  quote           Quote   @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  vendorId        String?
  vendor          Vendor? @relation(fields: [vendorId], references: [id])
  vendorName      String?
  partNumber      String?
  partUrl         String?
  basePriceCents  Int     @default(0)
  markupPercent   Float   @default(0)
  finalPriceCents Int     @default(0)
  notes           String?
}

model QuoteAddonSelection {
  id               String @id @default(cuid())
  quoteId          String
  quote            Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  quotePartId      String?
  quotePart        QuotePart? @relation(fields: [quotePartId], references: [id], onDelete: Cascade)
  addonId          String
  addon            Addon  @relation(fields: [addonId], references: [id])
  units            Float  @default(0)
  rateTypeSnapshot String
  rateCents        Int
  totalCents       Int
  notes            String?

  @@index([quotePartId])
}

model QuoteAttachment {
  id          String   @id @default(cuid())
  quoteId     String
  quote       Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  url         String?
  storagePath String?
  label       String?
  mimeType    String?
  createdAt   DateTime @default(now())

  @@index([storagePath])
}

model AppSettings {
  id                      String   @id @default("singleton")
  companyName             String   @default("Shopapp1")
  logoPath                String?
  themePrimary            String   @default("#0ea5e9")
  themeAccent             String   @default("#a855f7")
  attachmentsDir          String   @default("/app/storage")
  requirePOForQuoteApproval Boolean @default(true)
  requirePOForQuoteToOrder Boolean @default(false)
  invoiceTemplateId       String   @default("classic")
  invoiceOptions          String?
  updatedAt               DateTime @updatedAt
}

model CustomField {
  id          String   @id @default(cuid())
  entityType  String
  name        String
  key         String   @unique
  fieldType   String
  description String?
  businessCode String?
  defaultValue String?
  isRequired  Boolean  @default(false)
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  options     CustomFieldOption[]
  values      CustomFieldValue[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([entityType])
  @@index([businessCode])
  @@index([isActive])
}

model CustomFieldOption {
  id        String   @id @default(cuid())
  fieldId   String
  field     CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  label     String
  value     String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)

  @@index([fieldId])
}

model CustomFieldValue {
  id        String   @id @default(cuid())
  fieldId   String
  field     CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  entityId  String
  value     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fieldId, entityId])
  @@index([entityId])
}

model DocumentTemplate {
  id          String   @id @default(cuid())
  name        String
  documentType String
  description String?
  businessCode String?
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  schemaVersion Int     @default(1)
  currentVersion Int    @default(1)
  layoutJson  String
  versions    DocumentTemplateVersion[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([documentType])
  @@index([businessCode])
  @@index([isDefault])
  @@index([isActive])
}

model DocumentTemplateVersion {
  id          String   @id @default(cuid())
  templateId  String
  template    DocumentTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  version     Int
  schemaVersion Int
  layoutJson  String
  createdAt   DateTime @default(now())

  @@unique([templateId, version])
  @@index([templateId])
}
