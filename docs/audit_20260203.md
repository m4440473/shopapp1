# Audit — 2026-02-03 (Ranked, Top 15)

Scope: backend + data-flow stabilization, quote flow operability, checklist/addon semantics, timer persistence, and build reliability.

1) **Build fails on public attachments route typing**
   - **Symptom:** `next build` fails with invalid `GET` export typing for `RouteContext` params.
   - **Root cause hypothesis:** `GET` handler signature uses `{ params: { path: string[] } }` instead of Next.js 15 `RouteContext` typing.
   - **Files:** `src/app/(public)/attachments/[...path]/route.ts`
   - **Fix approach:** Update handler signature to match Next 15 `RouteContext` (likely `Promise<{ params: { path: string[] } }>`), and align imports with Next’s generated typing.
   - **Verification:** `npm run build` succeeds.

2) **DB setup script ignores .env**
   - **Symptom:** postinstall warns `DATABASE_URL not set; skipping automatic database setup.` even with `.env` present.
   - **Root cause hypothesis:** `scripts/setup-db.cjs` does not load dotenv before checking env.
   - **Files:** `scripts/setup-db.cjs`
   - **Fix approach:** `require('dotenv').config()` before reading `process.env.DATABASE_URL`.
   - **Verification:** `DATABASE_URL` from `.env` is recognized during postinstall; setup runs when set.

3) **@next/swc version mismatch**
   - **Symptom:** `next build` warns about `@next/swc` version 15.5.7 with Next 15.5.11.
   - **Root cause hypothesis:** lockfile pins `@next/swc` to an older patch, likely from cached install or dependency drift.
   - **Files:** `package-lock.json`, `package.json`
   - **Fix approach:** Align `@next/swc` version via lockfile update (no dependency upgrade beyond patch alignment).
   - **Verification:** `next build` logs no swc mismatch warning.

4) **Work item catalog split across addon/charge/checklist**
   - **Symptom:** Quote and order flows treat addons, labor, and checklist items as separate concepts.
   - **Root cause hypothesis:** `Addon`, `OrderCharge`, and `OrderChecklist` models overlap and store catalog vs instance data inconsistently.
   - **Files:** `prisma/schema.prisma`, `src/modules/orders/*`, `src/modules/quotes/*`
   - **Fix approach:** Introduce or extend a single catalog model (e.g., `WorkItemDefinition`) with `affectsPrice` and `isChecklistItem` flags; keep existing fields for compatibility.
   - **Verification:** New schema supports pricing-only and checklist-only items without duplicating definitions.

5) **Checklist items not strictly per-part**
   - **Symptom:** Checklist display/toggles can include order-level items or items not tied to a part.
   - **Root cause hypothesis:** `OrderChecklist` still allows `partId` nullable and checklist instantiation not consistently per part.
   - **Files:** `prisma/schema.prisma`, order checklist APIs in `src/app/api/orders/*`
   - **Fix approach:** Ensure checklist rows are instantiated per part on quote->order promotion, and UI only shows per-part checklist items.
   - **Verification:** Order part view shows only checklist items for that part and toggles persist.

6) **Quote editor work items not per-part**
   - **Symptom:** Quote editor drag/drop or selection may be quote-wide or inconsistent per part.
   - **Root cause hypothesis:** `QuoteAddonSelection` allows `quotePartId` nullable; UI may attach items at quote level.
   - **Files:** `prisma/schema.prisma`, `src/app/admin/quotes/*`
   - **Fix approach:** Require part association in quote editor UX and create `QuotePartWorkItem` selections per part.
   - **Verification:** Quote editor can add work items to specific parts with totals recalculated per part.

7) **Quote flow includes part finish too early**
   - **Symptom:** Part finish fields appear in intake step rather than later build step.
   - **Root cause hypothesis:** Custom fields (Finish Required) shown in early section.
   - **Files:** `src/app/admin/quotes/*`, `src/modules/quotes/*`, `CustomField.uiSection`
   - **Fix approach:** Keep field but render in later step based on `uiSection`.
   - **Verification:** Finish Required appears in later step without losing data.

8) **Attachments not scoped to part vs order**
   - **Symptom:** Drawings/STEP files not clearly attached to parts; order-level attachments hold part-specific files.
   - **Root cause hypothesis:** Quote attachments are order-level only, and part attachments aren’t wired in quote flow.
   - **Files:** `src/app/admin/quotes/*`, `src/app/api/orders/parts/*`, `prisma/schema.prisma`
   - **Fix approach:** Add part-level attachment workflow for quote parts; keep assembly-level only at order/quote.
   - **Verification:** Drawings/STEP files show on part and survive quote->order conversion.

9) **Pricing totals include checklist-only items**
   - **Symptom:** Pricing totals may count checklist-only items that shouldn’t affect price.
   - **Root cause hypothesis:** No `affectsPrice` flag; totals sum all work items.
   - **Files:** quote totals in `src/modules/quotes/*`, order totals in `src/modules/orders/*`
   - **Fix approach:** Add `affectsPrice` to catalog and filter totals accordingly.
   - **Verification:** Unit test verifying totals ignore checklist-only items.

10) **Quote->order promotion doesn’t instantiate per-part checklist**
   - **Symptom:** Order checklist view missing items or uses quote data directly.
   - **Root cause hypothesis:** Promotion logic doesn’t create `OrderPartChecklistItem` rows.
   - **Files:** quote->order services in `src/modules/quotes/*` or `src/modules/orders/*`
   - **Fix approach:** Instantiate checklist rows for each part from quote work items where `isChecklistItem=true`.
   - **Verification:** Integration test verifies checklist rows exist per part after promotion.

11) **Timer persistence missing per-part time entry model**
   - **Symptom:** Timer start/stop UI doesn’t persist or inflates time.
   - **Root cause hypothesis:** Time APIs either missing or not storing start/end/duration consistently; active-entry conflicts not enforced.
   - **Files:** `src/modules/time/*`, `src/app/api/time/*`
   - **Fix approach:** Implement `start`, `stop`, `switch` APIs with `TimeEntry` start/end and duration; enforce one active entry per user.
   - **Verification:** Unit test ensures duration calculation and stop/switch behavior.

12) **Timer UI not wired to new endpoints**
   - **Symptom:** Shop-facing timer controls don’t call API or update state.
   - **Root cause hypothesis:** UI still calling older endpoints or using placeholders.
   - **Files:** `src/app/orders/[id]/page.tsx`, related UI components
   - **Fix approach:** Minimal wiring to new endpoints; preserve UI layout.
   - **Verification:** Manual check: start/stop persists, switching tasks doesn’t inflate time.

13) **Work item definitions not filterable by department**
   - **Symptom:** Admin quote editor can’t filter work items by department or item type.
   - **Root cause hypothesis:** Work items sourced from addons without robust metadata.
   - **Files:** `src/app/admin/quotes/*`, `src/modules/quotes/*`
   - **Fix approach:** Use `departmentId` on definitions; filter left pane list accordingly.
   - **Verification:** Left pane filters list to relevant department items.

14) **Quote editor drag/drop may be unstable or missing**
   - **Symptom:** Drag/drop add items to parts is inconsistent or not implemented.
   - **Root cause hypothesis:** No binding between list and per-part assignments in client state.
   - **Files:** `src/app/admin/quotes/*`, `src/components/*` (drag/drop UI)
   - **Fix approach:** Implement stable drag/drop mapping to `QuotePartWorkItem`.
   - **Verification:** Manual: drag item to part adds row and persists on save.

15) **Checklist toggles not persisted per-part in order view**
   - **Symptom:** Checking a checklist item doesn’t persist or appears in the wrong part.
   - **Root cause hypothesis:** API toggles by order-level record or lacks part scoping.
   - **Files:** `src/app/api/orders/[id]/checklist/route.ts`, `src/modules/orders/*`
   - **Fix approach:** Require partId on toggle; ensure persisted `OrderPartChecklistItem` record updates.
   - **Verification:** Reload order view shows toggled state per part.
